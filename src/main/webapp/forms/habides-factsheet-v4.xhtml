<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xf="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:bf="http://betterform.sourceforge.net/xforms"
      xmlns:bfc="http://betterform.sourceforge.net/xforms/controls">
    <head>
        <title>HaBiDeS (Habitats and Birds Directive Derogation System)</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta http-equiv="cache-control" content="no-cache" />
        <meta http-equiv="expires" content="-1" />
        <meta name="Publisher" content="EEA, The European Environment Agency" />

        <meta name="author" content="enriko at tripledev.ee"/>
        <meta name="description" content="XForms for HaBiDeS (Habitats and Birds Directive Derogation System)"/>

        <link rel="stylesheet" type="text/css" href="http://www.eionet.europa.eu/styles/eionet2007/print.css" media="print" />
        <link rel="stylesheet" type="text/css" href="http://www.eionet.europa.eu/styles/eionet2007/handheld.css" media="handheld" />
        <link rel="stylesheet" type="text/css" href="http://www.eionet.europa.eu/styles/eionet2007/screen.css" media="screen" title="Eionet 2007 style" />
        <link rel="stylesheet" type="text/css" href="../../bfResources/scripts/dojox/highlight/resources/highlight.css" />

        <style type="text/css">
            .bold{
                font-weight: bold;
                padding-right:5px;
            }
            .bold label{
                font-weight: bold;
                padding-right:5px;
                font-size:0.8em;
            }
            .section {
                margin-top: 10px;
                padding: 5px;
            }
            div.section {
                background: #f3f3f3;
            }
            div.header{
                background-color: #dddddd;
                border-color: #aaaaaa;
            }
            div.bottom-buttons{
                background-color: #dddddd;
                border-color: #aaaaaa;
            }
        </style>
        <xf:model id="main-model">
            <!-- ##########            DEFAULT instance          ############-->
            <xf:instance xmlns="" id="default">
                <derogations/>
            </xf:instance>
            <!-- instance for EMPTY XML structure -->
            <xf:instance xmlns="" id="emptyinstance" src="http://webq.eionet.europa.eu/xml/habides-derogations-instance.xml">
                <derogations/>
            </xf:instance>
            <!-- ##########            SUBMISSIONS          ############ -->
            <xf:submission id="load-instance" method="GET" replace="instance" resource="{ instance('context')/instanceUrl }" instance="default">
                <xf:action ev:event="xforms-submit-done"/>
                <xf:action ev:event="xforms-submit-error">
                    <xf:message>An error occurred when loading instance data!</xf:message>
                </xf:action>
            </xf:submission>
            <xf:submission id="load-emptyinstance" method="GET" replace="instance" resource="{ instance('context')/emptyInstanceUrl }" instance="emptyinstance"/>

            <!--submission for saving XML -->
            <xf:submission id="savexml" action="{$base_uri}/saveXml?fileId={$fileId}" method="post" replace="instance" encoding="UTF-8" instance="saveresult" validate="false">
                <!--
                <xf:message ev:event="xforms-submit-done" ref="instance('context')/save_message"/>
                -->
                <xf:dispatch targetid="main-model" name="reset-content-modified" ev:event="xforms-submit-done" />

                <xf:action ev:event="xforms-submit-error">
                    <xf:setvalue ref="instance('saveresult')/code" value="0"/>
                    <xf:setvalue ref="instance('saveresult')/message" value="'Error on saving data!'"/>
                    <xf:setvalue ref="instance('saveresult')/timestamp" value="current-dateTime()"/>
                    <xf:message>Error on saving data!</xf:message>

                </xf:action>
            </xf:submission>
            <!-- instance for showing save result messages from WebQ system -->
            <xf:instance xmlns="" id="saveresult">
                <saveresult>
                    <code desc="Result code: 0-ERROR;1-OK">-1</code>
                    <message desc="Save result message"/>
                    <timestamp desc="Result time"/>
                </saveresult>
            </xf:instance>
            <!-- bindings for save result -->
            <xf:bind id="b-saveresult-message" nodeset="instance('context')/save_message" relevant="instance('saveresult')/code &gt; -1" calculate="concat(instance('saveresult')/message, ' (', translate(substring-before(instance('saveresult')/timestamp, '.'),'T',' '), ')')"/>
            <xf:bind id="b-saveresult-message-ok" nodeset="instance('context')/save_message_ok" relevant="instance('saveresult')/code = 1" calculate="../save_message"/>
            <xf:bind id="b-saveresult-message-err" nodeset="instance('context')/save_message_err" relevant="instance('saveresult')/code = 0" calculate="../save_message"/>

            <!-- ##########            DEFAULT instance BINDINGS          ############-->
                <!--xf:bind id="b-lang" nodeset="/derogations/@xml:lang" required="true()"/-->
            <xf:bind id="b-country" nodeset="/derogations/@country" required="true()"/>
            <xf:bind id="b-derogation" nodeset="derogation">
                <xf:bind nodeset="@derogation_reference"/>
                <!--xf:bind id="b-user_derog_ref" nodeset="derogation/@user_derogation_ref"/-->

                <xf:bind id="b-directive" nodeset="@directive" required="true()"/>
                <xf:bind id="b-licensingAuthority" nodeset="licensingAuthority"/>
                <xf:bind id="b-validFrom" type="xs:date" nodeset="licenseValidFrom"/>
                <xf:bind id="b-validUntil" type="xs:date" nodeset="licenseValidUntil"/>
                <xf:bind id="b-sensitive" type="xs:boolean" nodeset="sensitive"/>
                <xf:bind id="b-numberOfLicenses" type="integer" nodeset="numberOfLicenses"/>
                <xf:bind id="b-alternativesAssessed" nodeset="alternativesAssessed" required="true()"/>
            </xf:bind>

            <!-- ##########       CONTEXT  INSTANCE         ############-->
            <!-- CONTEXT parameters instance and bindings eg. webq-lang, envelope, ... -->
            <xf:instance xmlns="" id="context">
                <data>
                    <!-- common helper data -->
                    <instanceUrl></instanceUrl>
                    <emptyInstanceUrl>http://webq.eionet.europa.eu/xml/habides-derogations-instance.xml</emptyInstanceUrl>
                    <save_message/>
                    <save_message_ok/>
                    <save_message_err/>
                    <contentModified>0</contentModified>


                    <!-- Habides form specific helper data -->
                    <user/>
                    <activeDirective/>
                </data>
            </xf:instance>
            <xf:bind id="b-user" nodeset="instance('context')/user" required="true()"/>

            <xf:instance xmlns="" id="countries" src="http://webq.eionet.europa.eu/xml/habides_country_lookup.xml"/>

            <!-- Directives -->
            <xf:instance xmlns="" id="directives">
                <directives>
                    <directive id="http://rod.eionet.europa.eu/obligations/268" type="habitats">Habitats Directive</directive>
                    <directive id="http://rod.eionet.europa.eu/obligations/276" type="birds">Birds Directive</directive>
                </directives>
            </xf:instance>

            <!-- ##########       ACTIONS         ############-->

            <xf:action ev:event="xforms-ready">
                <xf:setvalue ref="instance('context')/instanceUrl" value="bf:appContext('instance')" if="string-length(bf:appContext('instance')) &gt; 0"/>
                <xf:setvalue ref="instance('context')/instanceUrl" value="instance('context')/emptyInstanceUrl" if="string-length(bf:appContext('instance')) = 0"/>
                <xf:send submission="load-instance" name="xforms-submit"/>
                <xf:send submission="load-emptyinstance" name="xforms-submit"/>
                <xf:refresh/>
            </xf:action>
            <xf:action ev:event="set-content-modified">
                <xf:setvalue ref="instance('context')/contentModified" value="1"/>
            </xf:action>
            <xf:action ev:event="reset-content-modified">
                <xf:setvalue ref="instance('context')/contentModified" value="0"/>
            </xf:action>


            <xf:action ev:event="my-insert">
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@directive" value="instance('directives')/directive[@type=instance('context')/activeDirective]/@id"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@userIdentity" value="instance('context')/user"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@derogation_reference" value="concat(instance('default')/derogation[index('rDerogList')]/@userIdentity,'-',if(instance('context')/activeDirective='birds') then 'B'  else 'H','-',count(instance('default')/derogation[@directive=instance('directives')/directive[@type=instance('context')/activeDirective]/@id]),'-',substring(now(),1,4),substring(now(),6,2),substring(now(),9,2),substring(now(),12,2),substring(now(),15,2),substring(now(),18,2))"/>
            </xf:action>
            <xf:action ev:event="my-reset-all">
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@directive" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@userIdentity" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@derogation_reference" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@user_derogation_reference" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/licensingAuthority" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/licenseValidFrom" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/licenseValidUntil" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/sensitive" value="false()"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/numberOfLicenses" value="''"/>
                <xf:refresh/>
            </xf:action>
        </xf:model>
    </head>
    <body>
        <!-- ##################################            FORM HEADER            ############################################-->
        <h1>Habitats and Birds Derogations</h1>
        <xf:group bind="b-saveresult-message-ok">
            <div class="system-msg">
                <xf:output bind="b-saveresult-message"/>
            </div>
        </xf:group>
        <xf:group bind="b-saveresult-message-err">
            <div class="error-msg">
                <xf:output bind="b-saveresult-message"/>
            </div>
        </xf:group>

        <!-- ##################################          START QUESTIONNAIRE           ############################################-->
        <div class="section header">
            <xf:group>
                <xf:dispatch targetid="main-model" name="set-content-modified" ev:event="xforms-value-changed" />
                <xf:select1 appearance="minimal" bind="b-country" incremental="true">
                    <xf:label class="bold">Country</xf:label>
                    <xf:itemset nodeset="instance('countries')/data">
                        <xf:label ref="name"/>
                        <xf:hint ref="code"/>
                        <xf:value ref="code"/>
                    </xf:itemset>
                    <xf:alert>Mandatory field!</xf:alert>
                </xf:select1>

                <xf:input bind="b-user" incremental="true">
                    <xf:label class="bold">User Identity</xf:label>
                    <xf:alert>Mandatory field!</xf:alert>
                </xf:input>
            </xf:group>
        </div>
        <!-- ##################################          TABS          ############################################-->
        <!--
        <div>
<xf:group>
    <xf:label>Cases</xf:label>
    <div style="display:none;">
        <xf:trigger id="t-case-list">
            <xf:label>Derogations list</xf:label>
            <xf:toggle case="case-list"></xf:toggle>
        </xf:trigger>
        <xf:trigger id="t-case-edit">
            <xf:label>Edit derogation</xf:label>
            <xf:toggle case="case-edit"></xf:toggle>
        </xf:trigger>
        <xf:trigger id="t-case-view">
            <xf:label>View derogation</xf:label>
            <xf:toggle case="case-view"></xf:toggle>
        </xf:trigger>
    </div>

    <xf:switch id="switch1" appearance="dijit:TabContainer">
        <xf:case id="case-list" selected="true">
            <xf:label>Case 1</xf:label>
            <div class="caseContent" style="background:#bbbbff">
                <h2>List</h2>
            </div>
        </xf:case>
        <xf:case id="case-edit">
            <xf:label>Case 2</xf:label>
            <div class="caseContent" style="background:#ccccff">
                <h2>Edit</h2>
                <p>This is some content for the second case</p>
            </div>
        </xf:case>
        <xf:case id="case-view">
            <xf:label>View</xf:label>
            <div class="caseContent" style="background:#ddddff">
                <h2>CASE 3</h2>
                <p>This is some content for the third case</p>
            </div>
        </xf:case>
    </xf:switch>
</xf:group>
</div>
-->
        <div class="section">
        <!-- ##################################         DEROGATIONS LIST           ############################################-->
        <xf:group>
            <xf:dispatch targetid="main-model" name="set-content-modified" ev:event="xforms-value-changed" />
            <xf:repeat id="rDerogList" bind="b-derogation" appearance="compact">
                <xf:output ref="@derogation_reference">
                    <xf:label class="bold">Derogation Reference</xf:label>
                </xf:output>
                <xf:input ref="licenseValidFrom">
                    <xf:label class="bold">License Valid From</xf:label>
                </xf:input>
                <xf:input ref="licenseValidUntil">
                    <xf:label class="bold">License Valid Until</xf:label>
                </xf:input>
                <xf:input ref="sensitive">
                    <xf:label class="bold">Sensitive</xf:label>
                </xf:input>
            </xf:repeat>
        </xf:group>
        </div>
        <div class="section">
            <xf:group>
                <xf:trigger>
                    <xf:label>Create HABITATS derogation</xf:label>
                    <xf:action>
                        <xf:setvalue ref="instance('context')/activeDirective" value="'habitats'"/>
                        <xf:insert bind="b-derogation" at="last()" position="after" origin="instance('emptyinstance')/derogation"
                            if="count(instance('default')/derogation)&gt;1 or instance('default')/derogation[1]/@derogation_reference!=''"/>
                        <xf:dispatch targetid="main-model" name="my-insert"/>
                    </xf:action>
                </xf:trigger>
                <xf:trigger>
                    <xf:label>Create BIRDS derogation</xf:label>
                    <xf:action>
                        <xf:setvalue ref="instance('context')/activeDirective" value="'birds'"/>
                        <xf:insert bind="b-derogation" at="last()" position="after" origin="instance('emptyinstance')/derogation"
                            if="count(instance('default')/derogation)&gt;1 or instance('default')/derogation[1]/@derogation_reference!=''"/>
                        <xf:dispatch targetid="main-model" name="my-insert"/>
                    </xf:action>
                </xf:trigger>
                <xf:trigger>
                    <xf:label>Delete derogation</xf:label>
                    <xf:hint>Deletes selected derogation from report</xf:hint>
                    <xf:action>
                        <xf:dispatch targetid="main-model" name="my-reset-all"
                            if="count(instance('default')/derogation)=1 and instance('default')/derogation[1]/@derogation_reference!=''"/>
                        <xf:delete bind="b-derogation" at="index('rDerogList')" if="count(instance('default')/derogation)&gt;1"/>
                        <xf:dispatch targetid="main-model" name="set-content-modified"/>

                    </xf:action>
                </xf:trigger>
            </xf:group>
        </div>
        <div class="section bottom-buttons">
        <!-- ##################################          BUTTONS            ############################################-->
        <xf:group appearance="minimal">
            <xf:trigger id="tr_savedraft">
                <xf:label>Save</xf:label>
                <xf:hint>Saves the current status of the data into XML file, without moving away from the web form</xf:hint>
                <xf:action ev:event="DOMActivate">
                    <xf:send submission="savexml" name="xforms-submit"/>
                </xf:action>
            </xf:trigger>
            <xf:trigger id="tr_finish">
                <xf:label>Save &amp; Close</xf:label>
                <xf:hint>Saves the changes into XML file and opens the front page of WebQ</xf:hint>
                <xf:action ev:event="DOMActivate">
                    <xf:send submission="savexml" name="xforms-submit"/>
                    <xf:load ev:event="xforms-submit-done" resource="{$base_uri}" show="replace" if="instance('saveresult')/code=1"/>
                </xf:action>
            </xf:trigger>
            <xf:trigger id="tr_close">
                <xf:label>Close</xf:label>
                <xf:hint>Go back to WebQ front page.</xf:hint>
                <bfc:show dialog="closeConfirmationDialog" ev:event="DOMActivate" if="instance('context')/contentModified=1"/>
                <xf:load resource="{$base_uri}" show="replace" if="instance('context')/contentModified=0"/>
            </xf:trigger>
        </xf:group>
        </div>

        <bfc:dialog id="closeConfirmationDialog">
            <xf:label>The content is modified!</xf:label>
            <xf:group appearance="minimal">
                <p>You have unsaved modifications on the form.</p>
                <p>Cancel and Save your content if you want to store the modifications, otherwise continue with Close button.</p>
                <div class="section">
                <xf:trigger>
                    <xf:label>Cancel closing</xf:label>
                    <bfc:hide dialog="closeConfirmationDialog" ev:event="DOMActivate"></bfc:hide>
                </xf:trigger>
                <xf:trigger>
                    <xf:label>Close without saving</xf:label>
                    <xf:load resource="{$base_uri}" show="replace"/>
                </xf:trigger>
                </div>
            </xf:group>
        </bfc:dialog>
        <xf:output ref="instance('context')/contentModified"><xf:label>Content modified: </xf:label></xf:output>
    </body>
</html>
