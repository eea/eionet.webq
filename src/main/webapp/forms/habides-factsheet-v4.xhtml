<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xf="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:bf="http://betterform.sourceforge.net/xforms"
      xmlns:bfc="http://betterform.sourceforge.net/xforms/controls">
    <head>
        <title>HaBiDeS (Habitats and Birds Directive Derogation System)</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta http-equiv="cache-control" content="no-cache" />
        <meta http-equiv="expires" content="-1" />

        <meta name="author" content="enriko at tripledev.ee"/>
        <meta name="description" content="XForms for HaBiDeS (Habitats and Birds Directive Derogation System)"/>

        <!--  EIONET styles come from XSLT. -->

        <link rel="stylesheet" type="text/css" href="../bfResources/scripts/dojox/highlight/resources/highlight.css" />
        <link href="http://code.jquery.com/ui/1.10.3/themes/start/jquery-ui.min.css" rel="stylesheet" type="text/css"/>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
        <script type="text/javascript">
            $($.ajax({
                url: "/webq2/download/project/habides/file/habides_species_lookup.xml",
                type: "xml",
                method: "GET",
                success: function(xmlDocument) {
                    $(".specie_select input").autocomplete({
                        source: $("species specie", xmlDocument)
                                .map(function () {
                                    return {value: $(this).find("specname").text()};
                                }).get(),
                        minLength: 0
                    });
                }
            }));
        </script>
        <style type="text/css">
            .ui-autocomplete {
                z-index: 1000 !important;
            }
            .bold{
                font-weight: bold;
                padding-right:5px;
            }
            .bold label{
                font-weight: bold;
                padding-right:5px;
                font-size:0.8em;
            }
            .red{
                color:red;
                }
            .red .xfValue{
                color:red;
                }
            .bold label{
                font-weight: bold;
                padding-right:5px;
            }
            .bold span{
                font-weight: bold;
                padding-right:5px;
            }
            .semi-wide-inp input{
                width: 200px;
            }
            .wide-inp input{
                width: 600px;
            }
            .section {
                margin-top: 10px;
                padding: 5px;
            }
            div.section-buttons {
                margin-top: 10px;
                background: #f3f3f3;
                padding: 5px;
            }
            /*
            #workarea table.xfContainer {
                background-color: #f3f3f3;
                empty-cells: show;
            }
            */
            .datatable tr.xfRepeatHeader td{
                background-color: #F6F6F6;
                border-bottom: 2px solid white;
                font-weight: bold;
                text-align: center;
            }
            .xfContainer .appBfVerticalTable td.bfVerticalTableLabel{
                color: #666666;
                background-color: #F6F6F6;
                border-bottom: 2px solid white;
                font-weight: bold;
                text-align: right;
                margin: 0;
                padding: 0.3em;
                vertical-align: top;
            }
            div.header{
                background-color: #dddddd;
                border-color: #aaaaaa;
            }
            div.bottom-buttons{
                background-color: #dddddd;
                border-color: #aaaaaa;
            }
            .xfContainer .xfGroupLabel{
                color:steelblue;
                font-size:1.2em;
                font-weight:bold;
                margin-bottom:10px;
                margin-top:10px;
                border-bottom:thin solid;
            }
            .xfRepeatIndex{
                background-color: #e4f1bc;
            }
            #rConversions .xfRepeatIndex{
                background-color: #FFFFFF;
            }

            /*
            .xfInvalid > .widgetContainer > input, .xfInvalid > .widgetContainer > select{
                background-color:#A42322;
                color: white;
                font-style: italic;
            }
            */
        </style>
        <xf:model id="main-model">
            <!-- ##########            DEFAULT instance          ############-->
            <xf:instance xmlns="" id="default">
                <derogations/>
            </xf:instance>
            <!-- instance for EMPTY XML structure -->
            <xf:instance xmlns="" id="emptyinstance" src="http://webqdev.eionet.europa.eu/xml/habides-derogations-instance.xml">
                <derogations/>
            </xf:instance>
            <!-- ##########            SUBMISSIONS          ############ -->
            <xf:submission id="load-instance" method="GET" replace="instance" resource="{ instance('context')/instanceUrl }" instance="default" validate="false()">
                <xf:action ev:event="xforms-submit-done"/>
                <xf:action ev:event="xforms-submit-error">
                    <xf:message level="modal">An error occurred when loading instance data!</xf:message>
                </xf:action>
            </xf:submission>
            <xf:submission id="load-emptyinstance" method="GET" replace="instance" resource="{ instance('context')/emptyInstanceUrl }" instance="emptyinstance" validate="false()"/>

            <!--submission for saving XML -->
            <xf:submission id="savexml" action="{$base_uri}/saveXml?fileId={$fileId}" method="post" replace="instance" encoding="UTF-8" instance="saveresult" validate="false()">
                <!--
                <xf:message level="modal" ev:event="xforms-submit-done" ref="instance('context')/save_message"/>
                -->
                <xf:dispatch targetid="main-model" name="reset-content-modified" ev:event="xforms-submit-done" />
                <xf:message level="ephemeral" ev:event="xforms-submit-done" bind="b-saveresult-message"/>

                <xf:action ev:event="xforms-submit-error">
                    <xf:setvalue ref="instance('saveresult')/code" value="0"/>
                    <xf:setvalue ref="instance('saveresult')/message" value="'Error on saving data!'"/>
                    <xf:setvalue ref="instance('saveresult')/timestamp" value="current-dateTime()"/>
                    <xf:message level="modal">Error on saving data!</xf:message>

                </xf:action>
            </xf:submission>
            <!-- instance for showing save result messages from WebQ system -->
            <xf:instance xmlns="" id="saveresult">
                <saveresult>
                    <code desc="Result code: 0-ERROR;1-OK">-1</code>
                    <message desc="Save result message"/>
                    <timestamp desc="Result time"/>
                </saveresult>
            </xf:instance>

            <!-- bindings for save result -->
            <xf:bind id="b-saveresult-message" nodeset="instance('context')/save_message" relevant="instance('saveresult')/code &gt; -1" calculate="concat(instance('saveresult')/message, ' (', translate(substring-before(instance('saveresult')/timestamp, '.'),'T',' '), ')')"/>
            <xf:bind id="b-saveresult-message-ok" nodeset="instance('context')/save_message_ok" relevant="instance('saveresult')/code = 1" calculate="../save_message"/>
            <xf:bind id="b-saveresult-message-err" nodeset="instance('context')/save_message_err" relevant="instance('saveresult')/code = 0" calculate="../save_message"/>

            <!-- ##########            DEFAULT instance BINDINGS          ############-->
            <!--xf:bind id="b-lang" nodeset="/derogations/@xml:lang" required="true()"/-->
            <xf:bind id="b-country" nodeset="/derogations/@country" required="true()" constraint="string-length(.) &gt; 0"/>
            <xf:bind id="b-directive" nodeset="derogation/@directive" required="true()"/>
            <xf:bind id="b-licensingAuthority" nodeset="derogation/licensingAuthority" required="true()"/>
            <xf:bind id="b-validFrom" type="xs:date" nodeset="derogation/licenseValidFrom" required="true()" constraint="string-length(.)=0 or string-length(../licenseValidUntil)=0 or number(replace(., '-', '')) - number(replace(../licenseValidUntil, '-', '')) &lt; 0"/>
            <xf:bind id="b-validUntil" type="xs:date" nodeset="derogation/licenseValidUntil" required="true()" constraint="string-length(.)=0 or string-length(../licenseValidUntil)=0 or  number(replace(., '-', '')) - number(replace(../licenseValidFrom, '-', '')) &gt; 0"/>
            <xf:bind id="b-sensitive" type="xs:boolean" nodeset="derogation/sensitive"/>
            <xf:bind id="b-numberOfLicenses" nodeset="derogation/numberOfLicenses" constraint="string-length(.)=0 or number(.) &gt; 0"/>
            <xf:bind id="b-alternativesAssessed" nodeset="derogation/alternativesAssessed" required="true()"/>
            <xf:bind id="b-Justification-for-derogation-textarea" nodeset="derogation/derogationJustification"/>
            <xf:bind id="b-bioRegion" nodeset="derogation/bioRegions/bioRegion"/>
            <xf:bind id="b-bioRegion-code" nodeset="derogation/bioRegions/@code"/>
            <xf:bind id="b-region" nodeset="derogation/regions/region"/>
            <xf:bind id="b-regions-code" nodeset="derogation/regions/@code"/>
            <xf:bind id="b-location" nodeset="instance('default')/derogation/location"/>

            <!-- ##########       CONTEXT  INSTANCE         ############-->
            <!-- CONTEXT parameters instance and bindings eg. webq-lang, envelope, ... -->
            <xf:instance xmlns="" id="context">
                <data>
                    <!-- common helper data -->
                    <instanceUrl></instanceUrl>
                    <emptyInstanceUrl>http://webqdev.eionet.europa.eu/xml/habides-derogations-instance.xml</emptyInstanceUrl>
                    <save_message/>
                    <save_message_ok/>
                    <save_message_err/>
                    <contentModified>0</contentModified>


                    <!-- Habides form specific helper data -->
                    <derogIndex>1</derogIndex>
                    <user/>
                    <activeDirective/>
                    <trigger-switch/>
                    <tblDerogEmpty/>
                    <tblDerogFilled/>
                    <selBioRegion/>
                    <tblBioRegEmpty/>
                    <tblBioRegFilled/>
                    <tblSpeciesFilled/>
                    <tblSpeciesEmpty/>
                    <selRegion/>
                    <tblRegionEmpty/>
                    <tblRegionFilled/>
                    <ftActivity/>
                    <selActivity-birds/>
                    <selActivity-habitats/>
                    <tblActivityEmpty/>
                    <tblActivityFilled/>
                    <ftMethod/>
                    <selMethod-birds/>
                    <selMethod-habitats/>
                    <tblMethodEmpty/>
                    <tblMethodFilled/>
                    <speciesFreetextValue/>
                    <selSpecies-birds/>
                    <selSpecies-habitats/>
                    <selMainGroup/>
                    <selMiddleGroup/>
                    <selLowerGroup-birds/>
                    <selLowerGroup-habitats/>

                    <derogEditButton/>
                    <derogDeleteButton/>
                    <speciesDeleteButton/>
                </data>
            </xf:instance>
            <xf:bind id="b-user" nodeset="instance('context')/user" required="true()"  constraint="string-length(.) &gt; 0"/>
            <xf:bind nodeset="instance('context')/trigger-switch" readonly="false()"/>

            <!-- ##########           HELPER   BINDINGS          ############-->
            <xf:bind id="b-derogation-tblempty" nodeset="instance('context')/tblDerogEmpty" relevant="count(instance('default')/derogation)=1 and  string-length(instance('default')/derogation[1]/@directive)=0"/>
            <xf:bind id="b-derogation-tblfilled" nodeset="instance('context')/tblDerogFilled" calculate="count(instance('default')/derogation) &gt; 1 or  string-length(instance('default')/derogation[1]/@directive) &gt; 0"/>
            <xf:bind id="b-derogEditButton" nodeset="instance('context')/derogEditButton" relevant="instance('context')/tblDerogFilled='true'"/>
            <xf:bind id="b-derogDeleteButton" nodeset="instance('context')/derogDeleteButton" relevant="instance('context')/tblDerogFilled='true'"/>

            <xf:bind id="b-derogIndex" nodeset="instance('context')/derogIndex" type="xs:integer"/>

            <xf:bind id="b-tblSpeciesFilled" nodeset="instance('context')/tblSpeciesFilled" type="xs:boolean"
                calculate="count(instance('default')/derogation[position() = instance('context')/derogIndex]/species) &gt; 1 or  string-length(instance('default')/derogation[position() = instance('context')/derogIndex]/species[1]) &gt; 0"/>
            <xf:bind id="b-speciesDeleteButton" nodeset="instance('context')/speciesDeleteButton" relevant="instance('context')/tblSpeciesFilled='true'"/>

            <xf:bind id="b-species-freetext-value" nodeset="instance('context')/speciesFreetextValue"/>
            <xf:bind id="b-sel-species-birds" nodeset="instance('context')/selSpecies-birds" relevant="instance('context')/activeDirective='birds' "/>
            <xf:bind id="b-sel-species-habitats" nodeset="instance('context')/selSpecies-habitats" relevant="instance('context')/activeDirective='habitats' "/>


            <xf:instance xmlns="" id="countries" src="http://webqdev.eionet.europa.eu/xml/habides_country_lookup.xml"/>

            <xf:instance xmlns="" id="biogeo-regions" src="http://webqdev.eionet.europa.eu/xml/habides_bioregions_lookup.xml"/>
            <xf:instance xmlns="" id="regions" src="http://webqdev.eionet.europa.eu/xml/habides_nuts2_lookup.xml"/>
            <xf:instance xmlns="" id="methods" src="http://webqdev.eionet.europa.eu/xml/habides_methods_lookup.xml"/>
            <xf:instance xmlns="" id="reasons" src="http://webqdev.eionet.europa.eu/xml/habides_reasons_lookup.xml"/>
            <xf:instance xmlns="" id="methods" src="http://webqdev.eionet.europa.eu/xml/habides_methods_lookup.xml"/>
            <xf:instance xmlns="" id="species" src="http://webqdev.eionet.europa.eu/xml/habides_species_lookup.xml"/>

            <!-- Directives -->
            <xf:instance xmlns="" id="directives">
                <directives>
                    <directive id="http://rod.eionet.europa.eu/obligations/268" type="habitats">Habitats Directive</directive>
                    <directive id="http://rod.eionet.europa.eu/obligations/276" type="birds">Birds Directive</directive>
                </directives>
            </xf:instance>

            <!-- ##########       ACTIONS         ############-->

            <xf:action ev:event="xforms-ready">
                <xf:setvalue ref="instance('context')/instanceUrl" value="bf:appContext('instance')" if="string-length(bf:appContext('instance')) &gt; 0"/>
                <xf:setvalue ref="instance('context')/instanceUrl" value="instance('context')/emptyInstanceUrl" if="string-length(bf:appContext('instance')) = 0"/>
                <xf:send submission="load-instance" name="xforms-submit"/>
                <xf:send submission="load-emptyinstance" name="xforms-submit"/>
                <xf:setvalue ref="/derogations/@country" value="instance('countries')/data[lower-code=lower-case(bf:appContext('country'))]/code" if="string-length(/derogations/@country) = 0" />
                <xf:refresh/>
            </xf:action>
            <xf:action ev:event="set-content-modified">
                <xf:setvalue ref="instance('context')/contentModified" value="1"/>
            </xf:action>
            <xf:action ev:event="reset-content-modified">
                <xf:setvalue ref="instance('context')/contentModified" value="0"/>
            </xf:action>


            <xf:action ev:event="my-insert">
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@directive" value="instance('directives')/directive[@type=instance('context')/activeDirective]/@id"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@userIdentity" value="instance('context')/user"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@derogation_reference" value="concat(instance('default')/@country,'-',instance('default')/derogation[index('rDerogList')]/@userIdentity,'-',if(instance('context')/activeDirective='birds') then 'B'  else 'H','-',count(instance('default')/derogation[@directive=instance('directives')/directive[@type=instance('context')/activeDirective]/@id]),'-',substring(now(),1,4),substring(now(),6,2),substring(now(),9,2),substring(now(),12,2),substring(now(),15,2),substring(now(),18,2))"/>
            </xf:action>
            <xf:action ev:event="my-reset-all">

                <!-- TODO Reset all elements -->

                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@directive" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@userIdentity" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@derogation_reference" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/@user_derogation_reference" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/licensingAuthority" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/licenseValidFrom" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/licenseValidUntil" value="''"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/sensitive" value="false()"/>
                <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/numberOfLicenses" value="''"/>
                <xf:refresh/>
            </xf:action>
            <xf:action ev:event="my-edit">
                <xf:setvalue ref="instance('context')/activeDirective" value="instance('directives')/directive[@id = instance('default')/derogation[index('rDerogList')]/@directive]/@type"/>
                <xf:setvalue ref="instance('context')/derogIndex" value="index('rDerogList')"/>
            </xf:action>
        </xf:model>
        <xf:model id="lookups-model">
            <!-- Lookups-->
            <xf:instance xmlns="" id="species" src="http://webqdev.eionet.europa.eu/xml/habides_species_lookup.xml"/>
            <!--
            <xf:instance xmlns="" id="bioregions" src="xml/habides_bioregions_lookup.xml" />
            <xf:instance xmlns="" id="activities" src="xml/habides_activities_lookup.xml"/>
            <xf:instance xmlns="" id="methods" src="xml/habides_methods_lookup.xml"/>
            <xf:instance xmlns="" id="reasons" src="xml/habides_reasons_lookup.xml"/>
            <xf:instance xmlns="" id="countries" src="xml/habides_country_lookup.xml" />
            -->
<!-- species  -->
                <!--f:bind id="b-lowergr-label" nodeset="instance('context')/lowerGroupLabel" calculate="if(instance('directives')/directive[@id= instance('default')/derogation[index('rDerogList')]/@directive]/@type='habitats','Lower group','Family species')"/-->
                <xf:bind id="b-maingroup" nodeset="instance('species')/helpers/main_groups/main_group">
                    <xf:bind id="b-maingroup-name" nodeset="."/>
                </xf:bind>

<!--
                <xf:bind id="b-middlegroup" nodeset="instance('species')/helpers/middle_groups/middle_group[@main_group=instance('context')/selMainGroup]">
                    <xf:bind id="b-middlegroup-name" nodeset="."/>
                </xf:bind>

                <xf:bind id="b-lowergroup-habitats" nodeset="instance('species')/helpers/lower_groups[@type = 'habitats']/lower_group[@middle_group=instance('context')/selMiddleGroup]">
                    <xf:bind id="b-lowergroup-name-habitats" nodeset="."/>
                </xf:bind>

                <xf:bind id="b-lowergroup-birds" nodeset="instance('species')/helpers/lower_groups[@type = 'birds']/lower_group[@middle_group=instance('context')/selMiddleGroup]">
                    <xf:bind id="b-lowergroup-name-birds" nodeset="."/>
                </xf:bind>

                <xf:bind id="b-species-list-habitats" nodeset="instance('species')/species[@type = 'habitats']/specie[lower_group=instance('context')/selLowerGroup-habitats]">
                    <xf:bind id="b-species-name-habitats" nodeset="specname"/>
                </xf:bind>
                <xf:bind id="b-species-list-birds" nodeset="instance('species')/species[@type = 'birds']/specie[lower_group=instance('context')/selLowerGroup-birds]">
                    <xf:bind id="b-species-name-birds" nodeset="specname"/>
                </xf:bind>
-->
        </xf:model>
    </head>
    <body class="fullscreen">
        <div id="workarea">
        <!-- ##################################            FORM HEADER            ############################################-->
        <h1>Habitats and Birds Derogations</h1>
        <xf:group bind="b-saveresult-message-ok">
            <div class="system-msg">
                <xf:output bind="b-saveresult-message"/>
            </div>
        </xf:group>
        <xf:group bind="b-saveresult-message-err">
            <div class="error-msg">
                <xf:output bind="b-saveresult-message"/>
            </div>
        </xf:group>

        <!-- ##################################          START QUESTIONNAIRE           ############################################-->
        <div class="section header">
            <xf:group>
                <xf:dispatch targetid="main-model" name="set-content-modified" ev:event="xforms-value-changed" />
                <xf:select1 appearance="minimal" bind="b-country">
                    <xf:label class="bold">Country</xf:label>
                    <xf:itemset nodeset="instance('countries')/data">
                        <xf:label ref="name"/>
                        <xf:hint ref="code"/>
                        <xf:value ref="code"/>
                    </xf:itemset>
                    <xf:alert>Mandatory field!</xf:alert>
                </xf:select1>

                <xf:input bind="b-user">
                    <xf:label class="bold">User Identity</xf:label>
                    <xf:alert>Mandatory field!</xf:alert>
                </xf:input>
            </xf:group>
        </div>
        <!-- ##################################          TABS          ############################################-->
        <div>
<xf:group>
        <!--
    <div>
        <xf:trigger id="t-case-list" ref="instance('context')/trigger-switch">
            <xf:label>Derogations list</xf:label>
            <xf:toggle case="case-list"></xf:toggle>
        </xf:trigger>
        <xf:trigger id="t-case-edit">
            <xf:label>Edit derogation</xf:label>
            <xf:toggle case="case-edit"></xf:toggle>
            <xf:dispatch targetid="main-model" name="my-edit"/>
        </xf:trigger>
        <xf:trigger id="t-case-view">
            <xf:label>View derogation</xf:label>
            <xf:toggle case="case-view"></xf:toggle>
        </xf:trigger>
    </div>
    -->
    <xf:switch id="switch1">
        <xf:case id="case-list" selected="true">
            <xf:label>Case 1</xf:label>
            <div class="caseContent">
                <h2>List of derogations</h2>
        <!-- ##################################         DEROGATIONS LIST           ############################################-->
        <xf:group>
            <xf:repeat id="rDerogList" nodeset="derogation" appearance="compact" class="datatable">
                <xf:output ref="@derogation_reference">
                    <xf:label class="bold">Derogation Reference</xf:label>
                </xf:output>
                <xf:output value="if (string-length(@directive) &gt; 0) then if (@directive = instance('directives')/directive[@type='birds']/@id) then 'Birds' else 'Habitats' else ''">
                    <xf:label class="bold">Directive</xf:label>
                </xf:output>
                <xf:output ref="licenseValidFrom">
                    <xf:label class="bold">License Valid From</xf:label>
                </xf:output>
                <xf:output ref="licenseValidUntil">
                    <xf:label class="bold">License Valid Until</xf:label>
                </xf:output>
                <xf:output value="if (sensitive='true') then 'sensitive' else ''">
                    <xf:label class="bold">Sensitive</xf:label>
                </xf:output>
                <xf:trigger appearance="minimal" bind="b-derogEditButton">
                    <xf:label>Edit</xf:label>
                    <xf:hint>Open editing form</xf:hint>
                    <xf:toggle case="case-edit"></xf:toggle>
                    <xf:dispatch targetid="main-model" name="my-edit"/>
                </xf:trigger>
                <xf:trigger appearance="minimal" bind="b-derogDeleteButton">
                    <xf:label>Delete</xf:label>
                    <xf:hint>Deletes selected derogation from report</xf:hint>
                    <bfc:show dialog="deleteDerogationConfirmationDialog" ev:event="DOMActivate"/>
                </xf:trigger>

            </xf:repeat>
        </xf:group>

        <bfc:dialog id="deleteDerogationConfirmationDialog">
            <xf:label>Delete derogation report?</xf:label>
            <xf:group appearance="minimal">
                <p>Are you sure you want to delete the derogation report with reference <xf:output class="red" value="instance('default')/derogation[index('rDerogList')]/@derogation_reference"/>?</p>
                <div class="section">
                <xf:trigger>
                    <xf:label>Delete</xf:label>
                    <xf:dispatch targetid="main-model" name="my-reset-all"
                        if="count(instance('default')/derogation) = 1 and instance('default')/derogation[1]/@derogation_reference != ''"/>
                    <xf:delete ref="instance('default')/derogation" at="index('rDerogList')" if="count(instance('default')/derogation) > 1"/>
                    <xf:dispatch targetid="main-model" name="set-content-modified"/>
                    <bfc:hide dialog="deleteDerogationConfirmationDialog" ev:event="DOMActivate"></bfc:hide>
                </xf:trigger>
                <xf:trigger>
                    <xf:label>Cancel</xf:label>
                    <bfc:hide dialog="deleteDerogationConfirmationDialog" ev:event="DOMActivate"></bfc:hide>
                </xf:trigger>
                </div>
            </xf:group>
        </bfc:dialog>

        <div class="section section-buttons">
            <xf:group>
                <xf:trigger>
                    <xf:label>Create HABITATS derogation</xf:label>
                    <xf:action>
                        <xf:setvalue ref="instance('context')/activeDirective" value="'habitats'"/>
                        <xf:insert nodeset="/derogations/derogation" at="last()" position="after" origin="instance('emptyinstance')/derogation"
                            if="count(instance('default')/derogation)&gt;1 or instance('default')/derogation[1]/@derogation_reference!=''"/>
                        <xf:dispatch targetid="main-model" name="my-insert"/>
                        <xf:dispatch targetid="main-model" name="set-content-modified" ev:event="xforms-value-changed" />
                    </xf:action>
                </xf:trigger>
                <xf:trigger>
                    <xf:label>Create BIRDS derogation</xf:label>
                    <xf:action>
                        <xf:setvalue ref="instance('context')/activeDirective" value="'birds'"/>
                        <xf:insert nodeset="instance('default')/derogation" at="last()" position="after" origin="instance('emptyinstance')/derogation"
                            if="count(instance('default')/derogation)&gt;1 or instance('default')/derogation[1]/@derogation_reference!=''"/>
                        <xf:dispatch targetid="main-model" name="my-insert"/>
                        <xf:dispatch targetid="main-model" name="set-content-modified" ev:event="xforms-value-changed" />
                    </xf:action>
                </xf:trigger>

            </xf:group>
        </div>
        </div>
        <div style="color:red;margin-top:5px;">
            <xf:output value="if (instance('context')/contentModified = 1) then 'NOTE: there are unsaved changes! Remember to save this session.' else '' "/>
        </div>

        <!-- ##################################          LOCAL file info & BUTTONS            ############################################-->
        <xf:model id="fileinfo-model">
            <!-- session file metadata -->
            <xf:instance xmlns="" id="fileinfo" src="{$base_uri}/file/info?fileId={$fileId}"/>
            <!-- reload session file metadata -->
            <xf:submission id="reload-fileinfo" action="{$base_uri}/file/info?fileId={$fileId}" method="get" replace="instance" encoding="UTF-8" instance="fileinfo" validate="false"/>
            <!-- delete session file from database -->
            <xf:submission id="deleteXml" action="{$base_uri}{ instance('fileinfo')/deleteLink }" method="get" replace="none" validate="false"/>

            <xf:instance id="fileinfo-helper" xmlns="">
                <data>
                    <local/>
                    <remote/>
                    <contentModified/>
                </data>
            </xf:instance>
            <xf:bind id="b-local-file" nodeset="instance('fileinfo-helper')/local" relevant="instance('fileinfo')/isLocalFile = 'true'"/>
            <xf:bind id="b-remote-file" nodeset="instance('fileinfo-helper')/remote" relevant="instance('fileinfo')/isLocalFile = 'false'"/>
            <xf:action ev:event="update-fileinfo-content-modified">
                <xf:setvalue ref="bf:instanceOfModel('fileinfo-model', 'fileinfo-helper')/contentModified" value="bf:instanceOfModel('main-model', 'context')/contentModified"/>
                <xf:refresh />
            </xf:action>
        </xf:model>

        <xf:group model="fileinfo-model" bind="b-local-file">
            <h2>Session file overview</h2>
            <table class="datatable">
                <tr>
                    <th scope="col">View file as</th>
                    <td>
                        <xf:repeat nodeset="instance('fileinfo')/conversion" id="rConversions">
                            <xf:trigger id="showConversion" appearance="minimal">
                                <xf:label ref="description"/>
                                <xf:hint>The conversion opens in a new window.</xf:hint>
                                <xf:load resource="{$base_uri}{ instance('fileinfo')/conversionLink }{ instance('fileinfo')/conversion[index('rConversions')]/convert_id }" show="new"/>
                            </xf:trigger>
                        </xf:repeat>
                    </td>
                </tr>
                <tr>
                    <th scope="col">File size</th>
                    <td><xf:output ref="instance('fileinfo')/fileSize"/></td>
                </tr>
                <tr>
                    <th scope="col">Created</th>
                    <td><xf:output value="instance('fileinfo')/created"/></td>
                </tr>
                <tr>
                    <th scope="col">Updated</th>
                    <td><xf:output value="instance('fileinfo')/updated"/></td>
                </tr>
                <tr>
                    <th scope="col">Downloaded</th>
                    <td><xf:output value="instance('fileinfo')/downloaded"/></td>
                </tr>
            </table>

        <!-- ##################################   LOCAL FILE BUTTONS            ############################################-->
        <div class="section bottom-buttons">
            <xf:group appearance="minimal">
                <xf:trigger id="tr_savelocal">
                    <xf:label>Save to disk</xf:label>
                    <xf:hint>Saves the current status of the data to local computer.</xf:hint>
                    <xf:action ev:event="DOMActivate">
                        <xf:send submission="savexml" name="xforms-submit"/>
                        <xf:load resource="{$base_uri}{ instance('fileinfo')/downloadLink }" show="new"/>
                        <xf:send submission="reload-fileinfo" name="xforms-submit"/>
                        <!--  TODO replace fileinfo instance -->
                    </xf:action>
                </xf:trigger>
                <xf:trigger id="tr_delete_file">
                    <xf:label>Delete</xf:label>
                    <xf:hint>Delete session file.</xf:hint>
                    <bfc:show dialog="closeFileDeleteConfirmationDialog" ev:event="DOMActivate"/>
                </xf:trigger>
                <xf:trigger id="tr_close_localfile">
                    <xf:label>Close</xf:label>
                    <xf:hint>Go back to WebQ front page.</xf:hint>
                    <xf:dispatch targetid="fileinfo-model" name="update-fileinfo-content-modified"/>
                    <bfc:show dialog="closeConfirmationDialog" ev:event="DOMActivate" if="instance('fileinfo-helper')/contentModified=1"/>
                    <xf:load resource="{$base_uri}" show="replace" if="instance('fileinfo-helper')/contentModified=0"/>
                </xf:trigger>
            </xf:group>
        </div>

        </xf:group>
        <!-- ##################################   CDR BUTTONS            ############################################-->
        <!--  buttons for CDR -->
        <xf:group model="fileinfo-model" bind="b-remote-file">
          <div class="section bottom-buttons">
            <xf:trigger id="tr_savedraft">
                <xf:label>Save</xf:label>
                <xf:hint>Saves the current status of the data into XML file, without moving away from the web form</xf:hint>
                <xf:action ev:event="DOMActivate">
                    <xf:send submission="savexml" name="xforms-submit"/>
                </xf:action>
            </xf:trigger>
            <xf:trigger id="tr_finish">
                <xf:label>Save &amp; Close</xf:label>
                <xf:hint>Saves the changes into XML file and opens the front page of WebQ</xf:hint>
                <xf:action ev:event="DOMActivate">
                    <xf:send submission="savexml" name="xforms-submit"/>
                    <xf:load ev:event="xforms-submit-done" resource="{$base_uri}" show="replace" if="instance('saveresult')/code=1"/>
                </xf:action>
            </xf:trigger>
            <xf:trigger id="tr_close">
                <xf:label>Close</xf:label>
                <xf:hint>Go back to WebQ front page.</xf:hint>
                <xf:dispatch targetid="fileinfo-model" name="update-fileinfo-content-modified"/>
                <bfc:show dialog="closeConfirmationDialog" ev:event="DOMActivate" if="instance('fileinfo-helper')/contentModified=1"/>
                <xf:load resource="{$base_uri}" show="replace" if="instance('fileinfo-helper')/contentModified=0"/>
            </xf:trigger>
          </div>
        </xf:group>
            <bfc:dialog id="closeFileDeleteConfirmationDialog">
                <xf:label>Delete file?</xf:label>
                <xf:group appearance="minimal">
                    <p>You are deleting the session file. All inserted data will be lost.</p>
                    <div class="section">
                    <xf:trigger>
                        <xf:label>Delete file</xf:label>
                        <xf:send submission="deleteXml" name="xforms-submit"/>
                        <xf:load resource="{$base_uri}" show="replace"/>
                    </xf:trigger>
                    <xf:trigger>
                        <xf:label>Cancel</xf:label>
                        <bfc:hide dialog="closeFileDeleteConfirmationDialog" ev:event="DOMActivate"></bfc:hide>
                    </xf:trigger>
                    </div>
                </xf:group>
            </bfc:dialog>
            <bfc:dialog id="closeConfirmationDialog">
            <xf:label>The content is modified!</xf:label>
            <xf:group appearance="minimal">
                <p>You have unsaved modifications on the form.</p>
                <p>Cancel and Save your content if you want to store the modifications, otherwise continue with Close button.</p>
                <div class="section">
                <xf:trigger>
                    <xf:label>Cancel closing</xf:label>
                    <bfc:hide dialog="closeConfirmationDialog" ev:event="DOMActivate"></bfc:hide>
                </xf:trigger>
                <xf:trigger>
                    <xf:label>Close without saving</xf:label>
                    <xf:load resource="{$base_uri}" show="replace"/>
                </xf:trigger>
                </div>
            </xf:group>
        </bfc:dialog>


       </xf:case>

 <!-- ##################################         EDIT           ############################################-->
        <xf:case id="case-edit">
            <xf:label>Case 2</xf:label>
            <div class="caseContent">
                <h2>Edit derogation</h2>
                <div class="section-buttons">
                    <xf:trigger id="t-case-list">
                        <xf:label>Back to list of derogations</xf:label>
                        <xf:toggle case="case-list"></xf:toggle>
                    </xf:trigger>
                </div>
                <xf:group id="gDerogEdit" nodeset="instance('default')/derogation[index('rDerogList')]">
                    <xf:dispatch targetid="main-model" name="set-content-modified" ev:event="xforms-value-changed" />
                    <xf:group appearance="compact">
                        <xf:label>Derogation</xf:label>

                    <xf:group appearance="bf:verticalTable">
                        <xf:output class="semi-wide-inp bold" ref="@derogation_reference"><xf:label>Derogation reference</xf:label></xf:output>
                        <xf:output class="semi-wide-inp bold" value="instance('directives')/directive[@id = instance('default')//derogation[index('rDerogList')]/@directive]"><xf:label>Directive</xf:label></xf:output>
                        <xf:output class="semi-wide-inp" ref="@userIdentity"><xf:label>User Identity</xf:label></xf:output>
                        <xf:input class="semi-wide-inp" ref="@user_derogation_ref"><xf:label>User defined reference</xf:label></xf:input>
                        <xf:input class="semi-wide-inp" ref="licensingAuthority"><xf:label>Licensing authority</xf:label></xf:input>
                        <xf:input ref="licenseValidFrom" appearance="bf:iso8601" data-bf-params="date:'dd/MM/yyyy'">
                            <xf:label>License valid from</xf:label>
                            <xf:hint>Select the date when the license was valid from.</xf:hint>
                            <xf:alert>Required field. "Valid from" should be before "Valid until"</xf:alert>
                        </xf:input>
                        <xf:input ref="licenseValidUntil" appearance="bf:iso8601" data-bf-params="date:'dd/MM/yyyy'">
                            <xf:label>License valid until</xf:label>
                            <xf:hint>Select the date until the license is valid.</xf:hint>
                            <xf:alert>Required field. "Valid until" should be after "Valid from"</xf:alert>
                        </xf:input>
                        <xf:input class="semi-wide-inp" ref="numberOfLicenses"><xf:label >Number of licenses</xf:label><xf:hint>Numeric field</xf:hint><xf:alert>Numeric field &gt; 0</xf:alert></xf:input>
                        <xf:input ref="sensitive"><xf:label class="red">Sensitive</xf:label>
                        <!--
                                <xf:action ev:event="xforms-value-changed">
                                    <xf:setvalue f:ref="/derogations/derogation[index('rDerogList')]/sensitive" value="instance('context')/sensitive" />
                                </xf:action>
                        -->
                        </xf:input>
                    </xf:group>
                    </xf:group>

            <!-- ##################################         add species        ############################################-->

                    <xf:group appearance="compact">
                        <xf:label>Species</xf:label>
                        <xf:repeat appearance="compact" id="rSpecies" nodeset="species" class="datatable">
                            <xf:output ref="." class="wide-inp"><xf:label/></xf:output>
                            <xf:trigger appearance="minimal" bind="b-speciesDeleteButton">
                                <xf:label>Delete</xf:label>
                                <xf:setvalue ref="instance('default')/derogation[index('rDerogList')]/species[1]" value="''" if="count(instance('default')/derogation[index('rDerogList')]/species) = 1" />
                                <xf:delete nodeset="instance('default')/derogation[index('rDerogList')]/species" at="index('rSpecies')" if="count(instance('default')/derogation[index('rDerogList')]/species) > 1" />
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger>
                            <xf:label> Add species </xf:label>
                            <bfc:show dialog="speciesDialog" ev:event="DOMActivate"/>
                        </xf:trigger>
                    <bfc:dialog id="speciesDialog">
                        <xf:label>Add species</xf:label>
                        <xf:group appearance="bf:verticalTable">
                            <xf:output value="''"/>
                            <xf:input class="wide-inp specie_select" bind="b-species-freetext-value"><xf:label>Species as free text</xf:label></xf:input>
                        </xf:group>
                        <xf:group>
                            <div class="section-buttons">
                                <xf:trigger>
                                    <xf:label> Add </xf:label>
                                    <xf:insert at="last()" position="after" nodeset="/derogations/derogation[index('rDerogList')]/species"
                                        if="count(/derogations/derogation[index('rDerogList')]/species)&gt;1 or /derogations/derogation[index('rDerogList')]/species[1] != '' and
                                        (string-length(instance('context')/speciesFreetextValue) &gt; 0)"/>
                                    <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/species[index('rSpecies')]" value="instance('context')/speciesFreetextValue" if="string-length(instance('context')/*[name()=concat('selSpecies-',instance('context')/activeDirective)]) = 0 and string-length(instance('context')/speciesFreetextValue) > 0"/>
                                    <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/species[index('rSpecies')]" value="instance('context')/*[name()=concat('selSpecies-',instance('context')/activeDirective)]" if="string-length(instance('context')/*[name()=concat('selSpecies-',instance('context')/activeDirective)]) > 0 "/>
                                    <xf:setvalue ref="instance('context')/speciesFreetextValue" value="''" />
                                    <bfc:hide dialog="speciesDialog" ev:event="DOMActivate"></bfc:hide>
                                </xf:trigger>
                                <xf:trigger>
                                    <xf:label>Cancel</xf:label>
                                    <bfc:hide dialog="speciesDialog" ev:event="DOMActivate"></bfc:hide>
                                </xf:trigger>
                            </div>
                        </xf:group>
                    </bfc:dialog>
                </xf:group>

                <xf:group appearance="compact">
                        <xf:label>Justification for derogation (if species in unfavourable conservation status)</xf:label>

                        <xf:textarea  bind="b-Justification-for-derogation-textarea" style="width:64em;">

                        </xf:textarea>
                 </xf:group>
                <xf:group appearance="compact">
                        <xf:label class="bold">Bio-geographical regions</xf:label>
                        <xf:repeat appearance="compact" id="rBioGeoRegions" nodeset="/bioRegions/bioRegion" class="datatable">
                            <xf:output ref="." class="wide-inp"><xf:label/></xf:output>
                            <xf:trigger appearance="minimal" bind="b-speciesDeleteButton">
                                <xf:label>Delete</xf:label>
                                <xf:setvalue ref="instance('default')/derogation[index('rDerogList')]/bioRegions/bioRegion[1]" value="''" if="count(instance('default')/derogation[index('rDerogList')]/bioRegions/bioRegion) = 1" />
                                <xf:delete nodeset="instance('default')/derogation[index('rDerogList')]/bioRegions/bioRegion" at="index('rBioGeoRegions')" if="count(instance('default')/derogation[index('rDerogList')]/bioRegions/bioRegion) > 1" />
                            </xf:trigger>
                        </xf:repeat>
                        <xf:dispatch targetid="main-model" name="set-content-modified" ev:event="xforms-value-changed" />
                        <xf:select1 appearance="minimal" bind="b-bioRegion">
                            <xf:label class="bold">Bio-geographical regions</xf:label>
                            <xf:itemset nodeset="instance('biogeo-regions')/bioregions/bioregion">
                                <xf:label ref="name"/>
                                <xf:hint ref="code"/>
                                <xf:value ref="code"/>
                            </xf:itemset>
                            <xf:alert>Mandatory field!</xf:alert>
                        </xf:select1>
                        <xf:trigger>
                            <xf:label>Add bio-regions</xf:label>
                            <xf:insert at="last()" position="after" nodeset="/derogations/derogation[index('rDerogList')]/bioRegions/bioRegion"
                                 if="count(/derogations/derogation[index('rDerogList')]//bioRegions/bioRegion)&gt;1 or /derogations/derogation[index('rDerogList')]//bioRegions/bioRegion[1] != '' "/>
                <!--            <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/species[index('rBioGeoRegions')]" value="instance('context')/speciesFreetextValue" if="string-length(instance('context')/*[name()=concat('selSpecies-',instance('context')/activeDirective)]) = 0 and string-length(instance('context')/speciesFreetextValue) > 0"/>
                            <xf:setvalue ref="/derogations/derogation[index('rDerogList')]/species[index('rBioGeoRegions')]" value="instance('context')/*[name()=concat('selSpecies-',instance('context')/activeDirective)]" if="string-length(instance('context')/*[name()=concat('selSpecies-',instance('context')/activeDirective)]) > 0 "/>
                            <xf:setvalue ref="instance('context')/speciesFreetextValue" value="''" />
                -->            <bfc:hide dialog="speciesDialog" ev:event="DOMActivate"></bfc:hide>
                       </xf:trigger>
                </xf:group>
                <xf:group appearance="compact">
                        <xf:label>Regions</xf:label>
                </xf:group>
                 <xf:group appearance="compact">
                        <xf:label>Location</xf:label>
                         <xf:input ref="location"></xf:input>
                </xf:group>
                 <xf:group appearance="compact">
                        <xf:label>Alternatives assessed</xf:label>
                        <xf:textarea  bind="b-Justification-for-derogation-textarea" style="width:64em;">
                            <xf:label></xf:label>
                        </xf:textarea>
                </xf:group>
                 <xf:group appearance="compact">
                        <xf:label>Permitted Activities</xf:label>
                </xf:group>
                 <xf:group appearance="compact">
                        <xf:label>Permitted Methods</xf:label>
                </xf:group>
                <xf:group appearance="compact">
                        <xf:label>Reason for Granting License</xf:label>
                </xf:group>
                </xf:group>
                <div class="section-buttons">
                <xf:trigger id="t-case-list">
                    <xf:label>Back to list of derogations</xf:label>
                    <xf:toggle case="case-list"></xf:toggle>
                </xf:trigger>
                </div>
            </div>
        </xf:case>
        <xf:case id="case-view">
            <xf:label>View</xf:label>
            <div class="caseContent" style="background:#ddddff">
                <h2>View directive</h2>
                <p>This is some content for the third case</p>
            </div>
        </xf:case>
    </xf:switch>
</xf:group>
</div>
<!--  Debugging area  -->
<div style="display:none">
        <xf:output value="instance('context')/derogIndex"/>
        <xf:output value="instance('context')/tblSpeciesFilled"/>
        <xf:output value="count(if (instance('context')/derogIndex castable as xs:integer) then instance('default')/derogation[number(instance('context')/derogIndex)]/species else 1)"/>
        <xf:output ref="instance('context')/contentModified"><xf:label>Content modified: </xf:label></xf:output>
</div>
        </div>
    </body>
</html>
